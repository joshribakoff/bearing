#!/bin/bash

# Validate worktree invariants
# Usage: worktree-check [--quiet] [--json]
# Exit: Always 0 (for hook compatibility)
# --quiet: Suppress human-readable output on success
# --json: Output JSON for Claude Code hooks (implies --quiet for human output)

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SAILKIT_DIR="$(dirname "$SCRIPT_DIR")"
WORKSPACE_DIR="$(dirname "$SAILKIT_DIR")"
LOCAL_FILE="$WORKSPACE_DIR/local.jsonl"

QUIET=false
JSON=false
for arg in "$@"; do
    case $arg in
        --quiet) QUIET=true ;;
        --json) JSON=true ;;
    esac
done

VIOLATIONS=()
HEALTH_WARNINGS=()
HEALTH_FILE="$WORKSPACE_DIR/health.jsonl"

# First sync to get current state
"$SCRIPT_DIR/worktree-sync" > /dev/null 2>&1

if [ -f "$LOCAL_FILE" ]; then
    while IFS= read -r line; do
        folder=$(echo "$line" | sed -n 's/.*"folder":"\([^"]*\)".*/\1/p')
        branch=$(echo "$line" | sed -n 's/.*"branch":"\([^"]*\)".*/\1/p')
        base=$(echo "$line" | sed -n 's/.*"base":\([^,}]*\).*/\1/p')

        if [ "$base" = "true" ]; then
            if [ "$branch" != "main" ] && [ "$branch" != "master" ]; then
                VIOLATIONS+=("$folder:$branch")
            fi
        fi
    done < "$LOCAL_FILE"
fi

# Check health cache for warnings (stale PRs, unpushed commits)
if [ -f "$HEALTH_FILE" ]; then
    stale_count=$(grep -c '"prState":"MERGED"' "$HEALTH_FILE" 2>/dev/null) || stale_count=0
    unpushed_count=$(grep -c '"unpushed":[1-9]' "$HEALTH_FILE" 2>/dev/null) || unpushed_count=0

    [ "$stale_count" -gt 0 ] 2>/dev/null && HEALTH_WARNINGS+=("$stale_count stale worktrees (PR merged)")
    [ "$unpushed_count" -gt 0 ] 2>/dev/null && HEALTH_WARNINGS+=("$unpushed_count worktrees with unpushed commits")
fi

if [ "$JSON" = true ]; then
    # Output JSON for Claude Code hooks
    if [ ${#VIOLATIONS[@]} -eq 0 ] && [ ${#HEALTH_WARNINGS[@]} -eq 0 ]; then
        cat <<'EOF'
{
  "continue": true
}
EOF
    else
        # Build message
        MSG=""
        if [ ${#VIOLATIONS[@]} -gt 0 ]; then
            MSG+="BEARING WARNING: Base folders on wrong branch. "
            for v in "${VIOLATIONS[@]}"; do
                folder="${v%%:*}"
                branch="${v#*:}"
                MSG+="'$folder' is on '$branch' (should be main). "
            done
            MSG+="Fix with 'worktree-recover <folder>'. "
        fi
        if [ ${#HEALTH_WARNINGS[@]} -gt 0 ]; then
            MSG+="Health issues: "
            for w in "${HEALTH_WARNINGS[@]}"; do
                MSG+="$w. "
            done
            MSG+="Run 'worktree-status' for details."
        fi

        # Escape for JSON
        MSG=$(echo "$MSG" | sed 's/"/\\"/g')

        cat <<EOF
{
  "continue": true,
  "systemMessage": "$MSG"
}
EOF
    fi
    exit 0
fi

# Human-readable output
if [ ${#VIOLATIONS[@]} -eq 0 ] && [ ${#HEALTH_WARNINGS[@]} -eq 0 ]; then
    if [ "$QUIET" = false ]; then
        echo "✓ All invariants satisfied"
    fi
else
    if [ ${#VIOLATIONS[@]} -gt 0 ]; then
        echo "⚠️  BEARING: Worktree invariant violations detected!"
        echo ""
        for v in "${VIOLATIONS[@]}"; do
            folder="${v%%:*}"
            branch="${v#*:}"
            echo "✗ VIOLATION: Base folder '$folder' is on '$branch' (expected: main)"
        done
        echo ""
        echo "Fix with: worktree-recover <folder>"
        echo ""
    fi
    if [ ${#HEALTH_WARNINGS[@]} -gt 0 ]; then
        echo "⚠️  Health warnings:"
        for w in "${HEALTH_WARNINGS[@]}"; do
            echo "  - $w"
        done
        echo ""
        echo "Run 'worktree-status' for details"
    fi
fi
exit 0
