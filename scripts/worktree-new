#!/bin/bash
set -e

# Create a new worktree for a repo/branch combination
# Usage: worktree-new <repo> <branch> [--based-on <branch>] [--purpose <text>]

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
SAILKIT_DIR="$(dirname "$SCRIPT_DIR")"
WORKSPACE_DIR="$(dirname "$SAILKIT_DIR")"
WORKFLOW_FILE="$WORKSPACE_DIR/workflow.jsonl"
LOCAL_FILE="$WORKSPACE_DIR/local.jsonl"

# Parse arguments
REPO=""
BRANCH=""
BASED_ON="main"
PURPOSE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --based-on)
            BASED_ON="$2"
            shift 2
            ;;
        --purpose)
            PURPOSE="$2"
            shift 2
            ;;
        *)
            if [ -z "$REPO" ]; then
                REPO="$1"
            elif [ -z "$BRANCH" ]; then
                BRANCH="$1"
            fi
            shift
            ;;
    esac
done

if [ -z "$REPO" ] || [ -z "$BRANCH" ]; then
    echo "Usage: worktree-new <repo> <branch> [--based-on <branch>] [--purpose <text>]"
    echo "Example: worktree-new fightingwithai.com feature-branch --purpose 'Add login'"
    exit 1
fi

REPO_DIR="$WORKSPACE_DIR/$REPO"
WORKTREE_DIR="$WORKSPACE_DIR/$REPO-$BRANCH"
FOLDER_NAME="$REPO-$BRANCH"

if [ ! -d "$REPO_DIR/.git" ] && [ ! -f "$REPO_DIR/.git" ]; then
    echo "Error: $REPO_DIR is not a git repository"
    exit 1
fi

if [ -d "$WORKTREE_DIR" ]; then
    echo "Error: Worktree already exists: $WORKTREE_DIR"
    exit 1
fi

TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

# Auto-generate purpose if not provided and AI is enabled
if [ -z "$PURPOSE" ]; then
    # Try to generate from branch name using AI (opt-in only)
    AI_PURPOSE=$("$SCRIPT_DIR/bearing-ai" branch-purpose <<< "Branch: $BRANCH" 2>/dev/null)
    if [ -n "$AI_PURPOSE" ] && [ "$AI_PURPOSE" != "Branch: $BRANCH" ]; then
        PURPOSE="$AI_PURPOSE"
    fi
fi

echo "Creating worktree: $WORKTREE_DIR"
git -C "$REPO_DIR" worktree add "$WORKTREE_DIR" "$BRANCH" 2>/dev/null || \
git -C "$REPO_DIR" worktree add -b "$BRANCH" "$WORKTREE_DIR" "$BASED_ON"

# Add to workflow.jsonl (committable - branch metadata)
WORKFLOW_ENTRY="{\"repo\":\"$REPO\",\"branch\":\"$BRANCH\",\"basedOn\":\"$BASED_ON\",\"purpose\":\"$PURPOSE\",\"status\":\"in_progress\",\"created\":\"$TIMESTAMP\"}"
echo "$WORKFLOW_ENTRY" >> "$WORKFLOW_FILE"

# Add to local.jsonl (not committed - local worktree path)
LOCAL_ENTRY="{\"folder\":\"$FOLDER_NAME\",\"repo\":\"$REPO\",\"branch\":\"$BRANCH\",\"base\":false}"
echo "$LOCAL_ENTRY" >> "$LOCAL_FILE"

echo "Done. Worktree created at: $WORKTREE_DIR"
